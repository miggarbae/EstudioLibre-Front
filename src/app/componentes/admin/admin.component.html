<div class="container mt-5">
  <h2>üëë Panel de Administraci√≥n</h2>

  <!-- Buscador de archivos -->
  <div class="input-group mb-4">
    <input [(ngModel)]="terminoBusqueda" class="form-control" placeholder="Buscar archivos por nombre o usuario">
    <button class="btn btn-outline-primary" (click)="buscarArchivos()">Buscar</button>
  </div>

<!-- Resultado de b√∫squeda -->
<div *ngIf="usuarioSeleccionado && usuarioSeleccionado.username === 'B√∫squeda'" class="mt-4 p-4 border rounded bg-white shadow-sm">
  <h5 class="mb-3">üîç Resultados de la b√∫squeda para "<strong>{{ terminoBusqueda }}</strong>":</h5>

  <!-- Si no hay nada -->
  <div *ngIf="usuarioSeleccionado.archivos.length === 0 && (!usuarioSeleccionado.usuariosCoincidentes || usuarioSeleccionado.usuariosCoincidentes.length === 0)">
    <p class="text-muted text-center fs-5">‚ùå No se encontraron resultados.</p>
  </div>

    <!-- Secci√≥n de archivos -->
    <div *ngIf="usuarioSeleccionado.archivos.length > 0" class="mb-4">
      <h6 class="mb-3 border-bottom pb-2">üìÑ Archivos encontrados:</h6>
      <ul class="list-group">
        <li *ngFor="let archivo of usuarioSeleccionado.archivos" class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ archivo.nombre }}</strong><br />
            <small>{{ archivo.asignatura }} | {{ archivo.nivelEstudio }}</small>
          </div>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-warning me-2" (click)="cambiarVisibilidad(archivo)">
              {{ archivo.visible ? 'Ocultar' : 'Mostrar' }}
            </button>
            <button class="btn btn-outline-danger" (click)="eliminarArchivo(archivo)">
              Eliminar
            </button>
          </div>
        </li>
      </ul>
    </div>

    <!-- Secci√≥n de usuarios -->
    <div *ngIf="usuarioSeleccionado.usuariosCoincidentes?.length > 0">
      <h6 class="mb-3 border-bottom pb-2">üë§ Usuarios encontrados:</h6>
      <ul class="list-group">
        <li *ngFor="let user of usuarioSeleccionado.usuariosCoincidentes" class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ user.username }}</strong><br />
            <small>Rol: {{ user.roles }}</small>
          </div>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-sm btn-outline-info me-2" (click)="toggleArchivos(user)">Ver Archivos</button>
            <button class="btn btn-outline-danger" (click)="eliminarUsuario(user.id)">Eliminar</button>
          </div>
        </li>
      </ul>
    </div>
  </div>

  <!-- Archivos Reportados -->
  <div class="container mt-4">
    <h4>üì¢ Archivos Reportados</h4>

    <div *ngIf="archivosReportados.length === 0">
      <p class="text-muted">No hay reportes actualmente.</p>
    </div>

    <div *ngFor="let reporte of archivosReportados" class="mb-3">
      <mat-card class="reporte-card">
        <mat-card-title>{{ reporte.archivo?.nombre || 'Archivo sin nombre' }}</mat-card-title>
        <mat-card-subtitle>Reportado por: {{ reporte.usuario?.username || 'Desconocido' }}</mat-card-subtitle>
        <mat-card-content>
          <p><strong>Motivo:</strong> {{ reporte.motivo }}</p>
          <p><strong>Fecha:</strong> {{ reporte.fecha }}</p>
          <button mat-button color="warn" (click)="eliminarReporte(reporte.id)">Eliminar Reporte</button>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Tabla de usuarios -->
  <div class="container mt-5">
    <h4>üë• Usuarios Registrados</h4>
  
    <table class="table table-bordered table-striped align-middle mt-3">
      <thead class="table-dark text-center">
        <tr>
          <th>Usuario</th>
          <th>Rol</th>
          <th>Archivos Subidos</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of usuarios">
          <td class="text-center">{{ user.username }}</td>
  
          <!-- Dropdown para cambiar rol -->
          <td class="text-center">
            <select
              [(ngModel)]="user.roles" (change)="actualizarRol(user)" class="form-select form-select-sm custom-select-role">
              <option value="USER">Usuario</option>
              <option value="ADMIN">Administrador</option>
            </select>
          </td>
  
          <td class="text-center">{{ user.archivos?.length || 0 }}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-info me-2" (click)="toggleArchivos(user)">
              {{ usuarioSeleccionado === user ? 'Ocultar Archivos' : 'Mostrar Archivos' }}
            </button>
            <button class="btn btn-sm btn-outline-danger" (click)="eliminarUsuario(user.id)">Eliminar</button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Archivos del usuario seleccionado -->
    <div *ngIf="usuarioSeleccionado && usuarioSeleccionado.username !== 'B√∫squeda'">
      <h5 class="mt-4">üìÇ Archivos de {{ usuarioSeleccionado.username }}:</h5>
      <ul class="list-group">
        <li *ngFor="let archivo of usuarioSeleccionado.archivos" class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            {{ archivo.nombre }} - {{ archivo.asignatura }} - {{ archivo.nivelEstudio }}
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-warning" (click)="cambiarVisibilidad(archivo)">
              {{ archivo.visible ? 'Ocultar' : 'Mostrar' }}
            </button>
            <button class="btn btn-sm btn-danger" (click)="eliminarArchivo(archivo)">Eliminar</button>
          </div>
        </li>
      </ul>
    </div>
  </div>
</div>
